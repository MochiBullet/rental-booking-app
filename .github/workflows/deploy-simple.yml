name: Simple Deploy to S3

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
      env:
        CI: false
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-2
    
    - name: Setup S3 bucket
      run: |
        BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
        
        # If no bucket name provided, create a unique one
        if [ -z "$BUCKET_NAME" ]; then
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="msbase-rental-$ACCOUNT_ID"
          echo "Generated bucket name: $BUCKET_NAME"
        fi
        
        # Create bucket if it doesn't exist
        if ! aws s3 ls "s3://$BUCKET_NAME" >/dev/null 2>&1; then
          echo "Creating bucket: $BUCKET_NAME"
          aws s3 mb "s3://$BUCKET_NAME" --region ap-southeast-2
        else
          echo "Bucket exists: $BUCKET_NAME"
        fi
        
        # Enable static website hosting
        aws s3 website "s3://$BUCKET_NAME" --index-document index.html --error-document index.html
        
        # Remove block public access
        aws s3api put-public-access-block \
          --bucket "$BUCKET_NAME" \
          --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
        
        # Create bucket policy
        cat > policy.json << EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::$BUCKET_NAME/*"
            }
          ]
        }
        EOF
        
        # Apply bucket policy
        aws s3api put-bucket-policy --bucket "$BUCKET_NAME" --policy file://policy.json
        
        # Clean up
        rm policy.json
    
    - name: Deploy to S3
      run: |
        BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
        if [ -z "$BUCKET_NAME" ]; then
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="msbase-rental-$ACCOUNT_ID"
        fi
        
        echo "Deploying to bucket: $BUCKET_NAME"
        
        # Upload all files
        aws s3 sync build/ s3://$BUCKET_NAME/ \
          --delete \
          --region ap-southeast-2
    
    - name: Show results
      run: |
        BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
        if [ -z "$BUCKET_NAME" ]; then
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="msbase-rental-$ACCOUNT_ID"
        fi
        
        echo "✅ Deployment completed successfully!"
        echo "🌐 Website URL: http://$BUCKET_NAME.s3-website-ap-southeast-2.amazonaws.com"
        echo "🔍 Check deployment: https://github.com/${{ github.repository }}/actions"
        echo ""
        echo "📋 Add this to GitHub Secrets if not set:"
        echo "S3_BUCKET_NAME = $BUCKET_NAME"