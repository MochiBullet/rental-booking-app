name: Simple Deploy to S3

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
      env:
        CI: false
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-2
    
    - name: Setup S3 bucket
      run: |
        BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
        
        # Create bucket if it doesn't exist
        aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null || aws s3 mb "s3://$BUCKET_NAME" --region ap-southeast-2
        
        # Enable static website hosting
        aws s3 website "s3://$BUCKET_NAME" --index-document index.html --error-document index.html
        
        # Remove block public access
        aws s3api put-public-access-block \
          --bucket "$BUCKET_NAME" \
          --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
        
        # Create bucket policy
        cat > policy.json << EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::$BUCKET_NAME/*"
            }
          ]
        }
        EOF
        
        # Apply bucket policy
        aws s3api put-bucket-policy --bucket "$BUCKET_NAME" --policy file://policy.json
        
        # Clean up
        rm policy.json
    
    - name: Deploy to S3
      run: |
        aws s3 sync build/ s3://${{ secrets.S3_BUCKET_NAME }}/ \
          --delete \
          --region ap-southeast-2 \
          --cache-control "public, max-age=31536000" \
          --exclude "*.html" \
          --exclude "service-worker.js" \
          --exclude "manifest.json"
        
        # Upload HTML files with no-cache
        aws s3 sync build/ s3://${{ secrets.S3_BUCKET_NAME }}/ \
          --region ap-southeast-2 \
          --cache-control "no-cache" \
          --include "*.html" \
          --include "service-worker.js" \
          --include "manifest.json"
    
    - name: Show results
      run: |
        BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
        echo "âœ… Deployment completed successfully!"
        echo "ðŸŒ Website URL: http://$BUCKET_NAME.s3-website-ap-southeast-2.amazonaws.com"
        echo "ðŸ” Check deployment: https://github.com/${{ github.repository }}/actions"