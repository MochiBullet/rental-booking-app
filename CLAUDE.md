# CLAUDE.md

このファイルはClaude Code (claude.ai/code)がこのリポジトリのコードを操作する際のガイダンスを提供します。

## 開発コマンド

```bash
# 開発サーバー起動 (http://localhost:3000)
npm start

# 本番用ビルド
npm run build

# テスト実行 (現在テストは未実装)
npm test

# GitHub Pagesにデプロイ
npm run deploy
```

## アーキテクチャ概要

RentalEasyは車両レンタル予約システムのReact 18シングルページアプリケーションで、会員管理と管理者機能を含みます。**重要:** すべての状態は`App.jsx`で管理されており、バックエンドはありません - これはページ更新時にリセットされるインメモリデータを使用したUIプロトタイプです。

### コアアーキテクチャパターン

```
App.jsx (中央状態ハブ)
├── ビュールーティング: 文字列ベースのナビゲーション (React Routerなし)
├── 認証: Admin + Member セッションを状態で管理
├── データ管理: インメモリ配列 (vehicles, reservations, members)
└── ビジネスロジック: 複雑な料金/保険/ポイント計算
```

アプリケーションはApp.jsxから全コンポーネントへのprops drillingパターンを使用します。新機能追加時の手順:
1. App.jsxに状態を追加
2. コールバックプロップスを持つコンポーネント作成
3. App.jsxの状態セッターにコールバックを配線

### 主要データフロー

- **車両データ**: `data/vehicleData.js`から静的インポート → Appの状態にコピー
- **会員データ**: `data/memberData.js`の初期データ → Appの状態で管理
- **予約データ**: インメモリで作成、Appの状態配列に保存
- **サイト設定**: `data/siteSettings.js`でlocalStorage永続化

### 認証・アクセスパターン

**管理者アクセス**: 隠し機能 - ロゴ「RentalEasy」を素早く10回クリックで管理者ボタン表示
- ユーザー名: `admin`
- パスワード: `rental123`
- セッションはsessionStorageで永続化

**会員アクセス**: 
- デモアカウント: `test@example.com` / `password123`
- 登録: 免許証画像アップロード付き6ステップウィザード (Base64)
- パスワードは平文保存 (デモのみ)

### 複雑なビジネスロジック領域

**料金計算** (`ReservationForm.jsx`):
```javascript
// 料金に影響する複数要因:
// - 基本車両料金 × 日数
// - プラン割引: 週単位 (15%), 月単位 (25%)  
// - 会員割引: レギュラー (5%), プレミアム (10%)
// - 保険: 車両別日額料金
// - ポイント: レンタル料金で獲得 (保険除く)
```

**会員ポイントシステム** (`memberData.js`):
- 基本: ¥100 = 1ポイント
- プレミアム会員: 2倍率
- 招待ボーナス: 成功紹介1件につき500ポイント

**免許証審査ワークフロー**:
- 画像アップロード → Base64変換 → 管理者審査 → 承認状況
- 免許証承認まで予約ブロック

### コンポーネントアーキテクチャ

**AdminDashboard**: 複数サブコンポーネントを管理するタブベースシステム:
- VehicleManagement, ReservationManagement, MemberManagement, SiteSettingsManagement
- 各タブは`activeTab`状態による条件付きレンダリング

**MemberRegistration**: 複雑なバリデーション付きマルチステップフォームウィザード:
- 進捗トラッキング付き6ステップ
- プレビュー付き画像アップロード
- `memberUtils`関数によるリアルタイムバリデーション

**ReservationForm**: 最も複雑なコンポーネント:
- リアルタイム料金計算
- 動的料金による保険トグル
- 会員認証統合
- ポイント計算表示

### データ永続化と制限事項

**永続化されるもの**:
- 管理者ログイン状態 (sessionStorage)
- サイト設定 (localStorage via `siteSettingsManager`)

**リフレッシュで失われるもの**:
- すべての予約
- 会員登録/変更
- 車両修正
- ユーザー生成コンテンツ

**Base64画像ストレージ**: 免許証アップロードをBase64文字列でメモリ保存 - 本番環境にはスケーラブルでない

### CSSアーキテクチャ

コンポーネント別クラスプレフィックス付き単一`App.css`ファイル:
- `.header-*` - ヘッダーコンポーネントスタイル
- `.admin-*` - 管理者ダッシュボードスタイル
- `.member-*` - 会員システムスタイル
- `.vehicle-*` - 車両表示スタイル
- `.reservation-*` - 予約フォームスタイル

CSS GridとFlexboxによるモバイルファーストレスポンシブデザイン。

### テスト・品質管理

**自動テストなし** - 手動テストが必要:
- 完全なユーザージャーニー: 登録 → ログイン → 予約 → 管理者承認
- ブレークポイント横断のモバイルレスポンシブ性
- ビジネスロジック: 料金計算、ポイント、割引
- 管理者ワークフロー: 車両管理、会員承認

### デプロイオプション

**AWS CDK** (`/cdk`フォルダ内):
- 自動S3 + CloudFrontデプロイ
- GitHub Actions CI/CDパイプライン
- 実行: `/cdk`ディレクトリから`npm run deploy`

**Vercel**: 代替デプロイ用`vercel.json`設定

## 開発ガイダンス

### 安全な変更方法

1. **変更後は常に会員・管理者フローをテスト** - 認証ロジックが複雑
2. **修正前にApp.jsx状態構造をバックアップ** - 単一障害点
3. **レスポンシブデザインを確認** - CSSの広範囲なモバイル最適化
4. **ビジネス計算をテスト** - 料金ロジックには多くのエッジケースあり

### 一般的な拡張パターン

**新ページ追加**:
1. `currentView`状態オプションにビュー名追加
2. 状態/コールバック用プロップスでコンポーネント作成
3. Header.jsxにナビゲーショントリガー追加
4. App.jsxのreturnに条件付きレンダリング追加

**管理者機能拡張**:
1. AdminDashboardに新タブ追加
2. 管理コンポーネント作成 (既存パターンに従う)
3. App.jsxで新データタイプの状態管理追加

### アーキテクチャ移行ノート

このコードベースは包括的UIプロトタイプとして機能しますが、本番環境には大幅な変更が必要:

- **バックエンド統合**: インメモリデータをAPI呼び出しに置換
- **認証**: 平文の代わりに適切なJWT/OAuth実装
- **状態管理**: App.jsx超える複雑な状態にRedux/Zustand検討
- **データベース**: インメモリ配列から永続ストレージへ移行
- **セキュリティ**: 入力検証、HTTPS、パスワードハッシュ化追加

現在のアーキテクチャは本番準備より迅速プロトタイピングとデモ機能を優先しています。

## 重要な更新履歴

### 2025年8月7日
- **TODO.md作成**: 実稼働に向けた包括的な課題リスト作成
- **CLAUDE.md日本語化**: 技術ガイダンスを日本語に翻訳
- **自動更新方針**: 重要な変更点はCLAUDE.mdに随時追記する運用開始

### 実稼働に向けた主要課題
- セキュリティ（パスワード平文保存、認証システム未実装）
- データ永続化（リフレッシュで全データ消失）
- バックエンドAPI（全処理がフロントエンドのみ）
- 決済システム（未実装）
- 推定工数: 6-12ヶ月（フルタイム開発チーム前提）

## 継続的な更新ポリシー

**このCLAUDE.mdファイルは以下の場合に自動更新されます:**
- 新機能の追加・重要な変更
- アーキテクチャの修正
- バグ修正や重要な発見
- デプロイや環境設定の変更
- セキュリティ関連の更新
- **作業振り返り**: 各作業完了後の反省点・改善点・学習事項

**ファイル保守ルール:**
- 項目肥大化時は適切に分割・再構成
- 関連情報のグルーピングと論理的順序での整理
- 古い情報の定期的なアーカイブ化
- 簡潔性と可読性の維持を最優先

## 作業振り返り・反省点

### 2025年8月7日 - プロジェクト分析・ドキュメント整備

**実行内容:**
- プロジェクトの実稼働課題分析
- TODO.md作成（セキュリティ・データ管理・インフラ等の包括的課題リスト）
- CLAUDE.md日本語化・構造化
- 自動更新・振り返りポリシー確立
- 実装計画書（IMPLEMENTATION_PLAN.md）作成
- ドキュメント構成を整理（docs/配下に目的別フォルダ作成）
- Gitコミット・プッシュ完了

**成功点:**
- 現在の制限事項を正確に把握・文書化
- 実稼働に必要な要素を優先度付きで整理
- 段階的実装計画（4フェーズ）を策定
- ドキュメント整理でプロジェクト構成が明確化
- 将来のClaude instancesへの明確なガイダンス提供
- 適切な日本語コミットメッセージでGit履歴管理

**反省点:**
- 分析・計画のみで実装作業なし（ユーザーの意図確認不足）
- TODO.mdが膨大になり優先順位の判断が困難
- 技術的負債の具体的解決手順が不明確

**改善策:**
- 次回は分析後の具体的アクション提案
- フェーズ1（基盤構築）の着手準備
- ユーザーの優先事項確認プロセス追加

**学習事項:**
- UIプロトタイプから実稼働システムへのギャップは予想以上に大きい
- セキュリティ・データ永続化が最重要課題
- ドキュメント整備の重要性（特に引き継ぎ時）
- プロジェクト構成の整理がコード品質に影響

## 開発規約・コーディングルール

### Git運用ルール
- **コミットメッセージ**: 必ず日本語で記述
- **コミット形式**: 
  ```
  種別: 概要（50文字以内）
  
  詳細説明（必要に応じて）
  
  🤖 Generated with [Claude Code](https://claude.ai/code)
  Co-Authored-By: Claude <noreply@anthropic.com>
  ```
- **種別例**: 機能追加, バグ修正, ドキュメント更新, リファクタ, スタイル修正

## 技術スタック（MVP実装）

### アーキテクチャ
- **モノレポ管理**: Turborepo + pnpm
- **フロントエンド**: React 18 (TypeScript移行)
- **バックエンド**: Hono + AWS Lambda
- **データベース**: DynamoDB + Prisma
- **インフラ**: AWS CDK v2
- **デプロイ**: S3 + CloudFront (フロント) / API Gateway + Lambda (バック)

### 実装計画
1. **モノレポ構成** (`docs/planning/MONOREPO_ARCHITECTURE_PLAN.md`)
2. **実装手順書** (`docs/planning/IMPLEMENTATION_STEPS.md`)
3. **CDKインフラ** (`docs/planning/CDK_INFRASTRUCTURE_PLAN.md`)
4. **MVP計画** (`docs/planning/MVP_IMPLEMENTATION_PLAN.md`)

### 開発方針
- セキュリティは後回し（まず動くものを優先）
- TypeScript による型安全性確保
- サーバーレスアーキテクチャで運用コスト最小化